<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Notas - FASAMAR</title>
<style>
/* Estilos Gerais (mantidos do código anterior) */
body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
.logo { text-align: center; margin-bottom: 20px; }
.logo img { max-width: 220px; }
.card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.2); max-width: 600px; margin: auto; }
input, button { width: 100%; padding: 10px; margin: 8px 0; font-size: 16px; }
button { background: #ec6a12; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
button:hover { background: #c95a0f; }
.resultado { margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 10px; }
.hidden { display: none; }
.discipline-table th, .discipline-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.discipline-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.logout-btn { background: #ccc; margin-top: 20px; }
.logout-btn:hover { background: #aaa; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
.import-section { border-top: 1px solid #ddd; padding-top: 20px; margin-top: 20px; }
.import-section input[type="file"] { width: auto; }
</style>
</head>
<body>

<div class="logo">
    <img src="logo.png" alt="file:///C:/Users/Usuario/Downloads/Fasamar.png">
</div>

<div class="card">
    <div id="viewLogin">
        <h2>Acesso ao Sistema de Notas</h2>
        <div class="form-group">
            <label for="username">Usuário (Nome):</label>
            <input type="text" id="username" placeholder="Digite seu nome de usuário">
        </div>
        <div class="form-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" placeholder="Digite sua senha">
        </div>
        <button onclick="autenticar()">Entrar</button>
    </div>

    <div id="viewProfessor" class="hidden">
        <h2>Painel do Professor</h2>
        
        <h3>Lançar Nota Individual</h3>
        <div class="form-group">
            <input type="text" id="nomeAlunoAdd" placeholder="Nome do Aluno">
        </div>
        <div class="form-group">
            <input type="text" id="disciplinaAdd" placeholder="Disciplina">
        </div>
        <div class="form-group">
            <input type="number" id="notaAdd" placeholder="Nota" min="0" max="10" step="0.1">
        </div>
        <button onclick="adicionarNota()">Lançar Nota Manualmente</button>

        <div class="import-section">
            <h3>Importar Dados via Arquivo TXT/CSV</h3>
            <p><small>Selecione um arquivo no formato: <code>Nome,Disciplina,Nota,Senha</code></small></p>
            <input type="file" id="fileInput" accept=".txt, .csv" onchange="importarDadosDoArquivo()">
            <p id="importStatus"></p>
        </div>

        <hr>
        <h3>Consultar Alunos Cadastrados</h3>
        <label>Buscar aluno:</label>
        <input type="text" id="busca" placeholder="Digite o nome..." onkeyup="buscarAlunoProfessor()">
        <ul id="listaAlunosProfessor"></ul>
        <div class="resultado hidden" id="resultadoProfessor"></div>

        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

    <div id="viewAluno" class="hidden">
        <h2 id="alunoViewTitle">Notas do Aluno:</h2>
        <div class="resultado" id="resultadoAlunoView"></div>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>

</div>

<script>
// Chave usada no localStorage para armazenar os dados
const STORAGE_KEY = 'sistemaNotasAlunosData';

// Dados iniciais de fallback (caso localStorage esteja vazio)
let alunos = [
    { nome: "Professor", senha: "admin", notas: {} } 
];

let usuarioLogado = null;

// --- Funções de Persistência de Dados (Novas) ---

function salvarDados() {
    // Converte o objeto alunos para uma string JSON e salva no localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(alunos));
}

function carregarDados() {
    // Tenta obter a string JSON do localStorage
    const dadosSalvos = localStorage.getItem(STORAGE_KEY);
    if (dadosSalvos) {
        // Se existir, converte de volta para objeto JavaScript
        alunos = JSON.parse(dadosSalvos);
    }
    // Se não houver dados salvos, a variável 'alunos' permanece com o valor inicial (apenas o Professor)
}

// --- Funções do Sistema (Modificadas para chamar salvarDados()) ---

function mudarVisualizacao(visualizacaoId) {
    document.getElementById('viewLogin').classList.add('hidden');
    document.getElementById('viewProfessor').classList.add('hidden');
    document.getElementById('viewAluno').classList.add('hidden');
    document.getElementById(visualizacaoId).classList.remove('hidden');
}

function autenticar() {
    let username = document.getElementById("username").value.trim();
    let password = document.getElementById("password").value.trim();
    usuarioLogado = alunos.find(u => u.nome.toLowerCase() === username.toLowerCase() && u.senha === password);

    if (usuarioLogado) {
        if (usuarioLogado.nome === "Professor") {
            mudarVisualizacao('viewProfessor');
            atualizarListaProfessor();
        } else {
            mudarVisualizacao('viewAluno');
            mostrarNotasAlunoLogado();
        }
    } else {
        alert("Usuário ou senha inválidos.");
    }
    document.getElementById("password").value = "";
}

function logout() {
    usuarioLogado = null;
    document.getElementById("username").value = "";
    mudarVisualizacao('viewLogin');
}

function mostrarNotasAlunoLogado() {
    if (!usuarioLogado) return;
    document.getElementById("alunoViewTitle").textContent = `Notas do Aluno: ${usuarioLogado.nome}`;
    let box = document.getElementById("resultadoAlunoView");
    let htmlContent = `<table class="discipline-table">
                        <thead>
                            <tr><th>Disciplina</th><th>Nota</th><th>Situação</th></tr>
                        </thead>
                        <tbody>`;
    
    for (const [disciplina, nota] of Object.entries(usuarioLogado.notas)) {
        let situacao = nota >= 7 ? "Aprovado" : "Reprovado";
        htmlContent += `<tr><td>${disciplina}</td><td>${nota.toFixed(2)}</td><td>${situacao}</td></tr>`;
    }
    htmlContent += `</tbody></table>`;
    box.innerHTML = htmlContent;
}

// --- Funções de Importação e Adição (Modificadas) ---

function importarDadosDoArquivo(event) {
    const input = event.target; // Usar event.target é melhor do que getElementById aqui
    const status = document.getElementById('importStatus');
    const file = input.files[0];

    if (!file) {
        status.textContent = "Nenhum arquivo selecionado.";
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const conteudo = e.target.result;
        processarConteudoDoArquivo(conteudo);
        status.textContent = "Importação concluída. Verifique a lista de alunos.";
        status.style.color = "green";
        input.value = ''; 
    };
    reader.onerror = function() {
        status.textContent = "Erro ao ler o arquivo.";
        status.style.color = "red";
    };

    reader.readAsText(file);
}

function processarConteudoDoArquivo(conteudo) {
    const linhas = conteudo.split('\n');
    let registrosImportados = 0;

    linhas.forEach(linha => {
        if (linha.trim() === '' || linha.toLowerCase().startsWith('nome,disciplina')) return;

        const campos = linha.trim().split(',');

        if (campos.length === 4) {
            const nome = campos[0].trim();
            const disciplina = campos[1].trim();
            const nota = Number(campos[2].trim());
            const senha = campos[3].trim();

            if (nome && disciplina && !isNaN(nota)) {
                adicionarOuAtualizarAluno(nome, disciplina, nota, senha);
                registrosImportados++;
            }
        }
    });

    salvarDados(); // Salva após a importação em massa
    atualizarListaProfessor();
    alert(`Total de ${registrosImportados} registros processados do arquivo.`);
}

function adicionarOuAtualizarAluno(nome, disciplina, nota, senha) {
    let alunoExistente = alunos.find(a => a.nome.toLowerCase() === nome.toLowerCase());

    if (alunoExistente) {
        alunoExistente.notas[disciplina] = nota;
        if (senha) alunoExistente.senha = senha;
    } else {
        let novoAluno = { 
            nome: nome, 
            senha: senha || "123",
            notas: {} 
        };
        novoAluno.notas[disciplina] = nota;
        alunos.push(novoAluno);
    }
}

function adicionarNota() {
    let nome = document.getElementById("nomeAlunoAdd").value.trim();
    let disciplina = document.getElementById("disciplinaAdd").value.trim();
    let nota = Number(document.getElementById("notaAdd").value);

    if (!nome || !disciplina || isNaN(nota) || nota < 0 || nota > 10) {
        alert("Preencha todos os campos corretamente (Nota entre 0 e 10).");
        return;
    }

    adicionarOuAtualizarAluno(nome, disciplina, nota, '123');
    salvarDados(); // Salva imediatamente após adicionar uma nota manual

    alert(`Nota lançada para ${nome}.`);
    document.getElementById("nomeAlunoAdd").value = "";
    document.getElementById("disciplinaAdd").value = "";
    document.getElementById("notaAdd").value = "";
    atualizarListaProfessor();
}

// ... as funções restantes de visualização do professor ...
function atualizarListaProfessor() {
    let ul = document.getElementById("listaAlunosProfessor");
    ul.innerHTML = "";
    alunos.filter(a => a.nome !== "Professor").forEach((aluno) => {
        let li = document.createElement("li");
        li.style.cursor = "pointer";
        li.style.padding = "5px 0";
        li.textContent = aluno.nome;
        li.onclick = () => mostrarAlunoProfessor(aluno);
        ul.appendChild(li);
    });
}

function mostrarAlunoProfessor(aluno) {
    let box = document.getElementById("resultadoProfessor");
    box.classList.remove('hidden');
    let htmlContent = `<strong>Aluno:</strong> ${aluno.nome}<br>`;
    htmlContent += `<table class="discipline-table">
                        <thead>
                            <tr><th>Disciplina</th><th>Nota</th></tr>
                        </thead>
                        <tbody>`;
    for (const [disciplina, nota] of Object.entries(aluno.notas)) {
        htmlContent += `<tr><td>${disciplina}</td><td>${nota.toFixed(2)}</td></tr>`;
    }
    htmlContent += `</tbody></table>`;
    box.innerHTML = htmlContent;
}

function buscarAlunoProfessor() {
    let texto = document.getElementById("busca").value.toLowerCase();
    let ul = document.getElementById("listaAlunosProfessor");
    ul.innerHTML = "";
    alunos
        .filter(a => a.nome !== "Professor" && a.nome.toLowerCase().includes(texto))
        .forEach((aluno) => {
            let li = document.createElement("li");
            li.style.cursor = "pointer";
            li.style.padding = "5px 0";
            li.textContent = aluno.nome;
            li.onclick = () => mostrarAlunoProfessor(aluno);
            ul.appendChild(li);
        });
}


// --- Inicialização ---
document.addEventListener('DOMContentLoaded', (event) => {
    carregarDados(); // Carrega os dados salvos ao iniciar a página
    mudarVisualizacao('viewLogin');
});
</script>
</body>
</html>
